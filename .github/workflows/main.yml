name: üöÄ Deploy to Cloud Run (Production)

on:
  push:
    branches:
      - main   # Deploy only when main branch is updated

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.REGION }}
  SERVICE_NAME: hostel-backend-prod     # Cloud Run service name
  REPO_NAME: hostelbe             # Artifact Registry repository name

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------
      # 1Ô∏è‚É£  Checkout Repository
      # -----------------------
      - name: üßæ Checkout code
        uses: actions/checkout@v4

      # -----------------------
      # 2Ô∏è‚É£  Set Up Google Cloud SDK
      # -----------------------
      - name: üîß Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      # -----------------------
      # 3Ô∏è‚É£  Authenticate Docker to Artifact Registry
      # -----------------------
      - name: üîê Authenticate Docker to Artifact Registry
        run: |
          echo "Authenticating Docker with Artifact Registry..."
          echo '${{ secrets.GCP_SA_KEY }}' > key.json
          gcloud auth activate-service-account --key-file=key.json
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # -----------------------
      # 4Ô∏è‚É£  Diagnostic Step (optional but helpful)
      # -----------------------
      - name: üîç Verify Authentication & Repository Access
        run: |
          echo "Listing authenticated accounts..."
          gcloud auth list
          echo "Checking Artifact Registry access..."
          gcloud artifacts repositories list --project ${{ env.PROJECT_ID }} --location=${{ env.REGION }}

      # -----------------------
      # 5Ô∏è‚É£  Build and Push Docker Image
      # -----------------------
      - name: üê≥ Build and Push Docker Image
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          echo "Building image: $IMAGE"
          docker build -t $IMAGE .
          echo "Pushing image to Artifact Registry..."
          docker push $IMAGE

      # -----------------------
      # 6Ô∏è‚É£  Deploy to Cloud Run
      # -----------------------
      - name: üöÄ Deploy to Cloud Run
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          echo "Deploying image: $IMAGE"
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image $IMAGE \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port 8080


