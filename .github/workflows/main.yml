name: üöÄ Deploy to Cloud Run (Production)

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.REGION }}
  SERVICE_NAME: pavan-app
  REPO_NAME: hostelbe

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: üßæ Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Generate Version (v1.0.x auto increase)
      - name: üè∑ Generate Semantic Version
        id: version
        run: |
          VERSION_FILE=version.txt

          # If version file exists,else start with v1.0.0
          if [ -f $VERSION_FILE ]; then
            VERSION=$(cat $VERSION_FILE)
          else
            VERSION="v1.0.0"
          fi

          echo "Current version: $VERSION"

          # Extract version numbers x.y.z
          IFS='.' read -r major minor patch <<< "${VERSION//v/}"

          # Increase PATCH version
          patch=$((patch + 1))

          NEW_VERSION="v$major.$minor.$patch"

          echo "New version: $NEW_VERSION"

          # Save new version to file
          echo $NEW_VERSION > $VERSION_FILE

          # Output version for next steps
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      # Commit updated version.txt
      - name: üîÑ Commit Version File
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add version.txt
          git commit -m "üîñ Bump version to ${{ steps.version.outputs.version }}"
          git push

      # 3Ô∏è‚É£ Setup gcloud
      - name: üîß Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      # 4Ô∏è‚É£ Authenticate Docker
      - name: üîê Authenticate Docker
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > key.json
          gcloud auth activate-service-account --key-file=key.json
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # 5Ô∏è‚É£ Build & Push Docker Image With Version Tag
      - name: üê≥ Build & Push Image
        run: |
          VERSION=${{ steps.version.outputs.version }}
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:$VERSION"
          echo "Building: $IMAGE"
          docker build -t $IMAGE .
          docker push $IMAGE

      # 6Ô∏è‚É£ Deploy to Cloud Run
      - name: üöÄ Deploy to Cloud Run
        run: |
          VERSION=${{ steps.version.outputs.version }}
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:$VERSION"
          echo "Deploying: $IMAGE"
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image $IMAGE \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port 8080




